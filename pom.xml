<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>org.joutak</groupId>
    <artifactId>JoupenPlugin</artifactId>
    <version>1.0-SNAPSHOT</version>
    <packaging>jar</packaging>

    <name>LoginPluginForJoutak</name>

    <properties>
        <java.version>17</java.version>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>

        <jooq.version>3.19.10</jooq.version>
        <hikari.version>5.1.0</hikari.version>
        <mariadb.version>3.4.1</mariadb.version>
        <mapstruct.version>1.6.0</mapstruct.version>
        <liquibase.version>4.27.0</liquibase.version>

        <!-- дефолты, если в YAML чего-то нет -->
        <database.url>jdbc:mariadb://localhost:3306/Joupen</database.url>
        <database.user>user</database.user>
        <database.password>user_password</database.password>
        <database.schema>Joupen</database.schema>
        <database.driver>org.mariadb.jdbc.Driver</database.driver>
    </properties>

    <dependencies>
        <!-- Paper API -->
        <dependency>
            <groupId>io.papermc.paper</groupId>
            <artifactId>paper-api</artifactId>
            <version>1.20.2-R0.1-SNAPSHOT</version>
            <scope>provided</scope>
        </dependency>

        <!-- Lombok -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>1.18.34</version>
            <scope>provided</scope>
        </dependency>

        <!-- MapStruct -->
        <dependency>
            <groupId>org.mapstruct</groupId>
            <artifactId>mapstruct</artifactId>
            <version>${mapstruct.version}</version>
        </dependency>
        <dependency>
            <groupId>org.mapstruct</groupId>
            <artifactId>mapstruct-processor</artifactId>
            <version>${mapstruct.version}</version>
            <scope>provided</scope>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok-mapstruct-binding</artifactId>
            <version>0.2.0</version>
            <scope>provided</scope>
        </dependency>

        <!-- jOOQ -->
        <dependency>
            <groupId>org.jooq</groupId>
            <artifactId>jooq</artifactId>
            <version>${jooq.version}</version>
        </dependency>
        <dependency>
            <groupId>org.jooq</groupId>
            <artifactId>jooq-codegen</artifactId>
            <version>${jooq.version}</version>
            <scope>provided</scope>
        </dependency>

        <!-- HikariCP -->
        <dependency>
            <groupId>com.zaxxer</groupId>
            <artifactId>HikariCP</artifactId>
            <version>${hikari.version}</version>
        </dependency>

        <!-- MariaDB JDBC -->
        <dependency>
            <groupId>org.mariadb.jdbc</groupId>
            <artifactId>mariadb-java-client</artifactId>
            <version>${mariadb.version}</version>
        </dependency>

        <!-- Liquibase -->
        <dependency>
            <groupId>org.liquibase</groupId>
            <artifactId>liquibase-core</artifactId>
            <version>${liquibase.version}</version>
            <scope>provided</scope>
        </dependency>

        <!-- Jackson -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
            <version>2.17.2</version>
        </dependency>
        <dependency>
            <groupId>com.fasterxml.jackson.datatype</groupId>
            <artifactId>jackson-datatype-jsr310</artifactId>
            <version>2.17.2</version>
        </dependency>

        <!-- SnakeYAML (используем и в коде, и в groovy-скрипте) -->
        <dependency>
            <groupId>org.yaml</groupId>
            <artifactId>snakeyaml</artifactId>
            <version>2.2</version>
        </dependency>

        <!-- Тесты / прочее -->
        <dependency>
            <groupId>org.junit.jupiter</groupId>
            <artifactId>junit-jupiter-api</artifactId>
            <version>5.11.0</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.junit.jupiter</groupId>
            <artifactId>junit-jupiter-engine</artifactId>
            <version>5.11.0</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.mockito</groupId>
            <artifactId>mockito-core</artifactId>
            <version>5.12.0</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.mockito</groupId>
            <artifactId>mockito-junit-jupiter</artifactId>
            <version>5.12.0</version>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>com.github.seeseemelk</groupId>
            <artifactId>MockBukkit-v1.20</artifactId>
            <version>3.33.0</version>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>com.github.t9t.minecraft-rcon-client</groupId>
            <artifactId>minecraft-rcon-client</artifactId>
            <version>1.0.0</version>
            <scope>test</scope>
            <exclusions>
                <exclusion>
                    <groupId>org.slf4j</groupId>
                    <artifactId>slf4j-api</artifactId>
                </exclusion>
            </exclusions>
        </dependency>

        <dependency>
            <groupId>org.testcontainers</groupId>
            <artifactId>testcontainers</artifactId>
            <version>1.20.1</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.testcontainers</groupId>
            <artifactId>mariadb</artifactId>
            <version>1.20.1</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.testcontainers</groupId>
            <artifactId>junit-jupiter</artifactId>
            <version>1.20.1</version>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
            <version>2.0.9</version>
        </dependency>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-jdk14</artifactId>
            <version>2.0.9</version>
        </dependency>
    </dependencies>

    <build>
        <plugins>

            <!-- Читаем plugins/joupen/config.yml, генерим target/jooq-config.xml и target/liquibase.properties -->
            <plugin>
                <groupId>org.codehaus.gmavenplus</groupId>
                <artifactId>gmavenplus-plugin</artifactId>
                <version>3.0.2</version>
                <dependencies>
                    <dependency>
                        <groupId>org.apache.groovy</groupId>
                        <artifactId>groovy</artifactId>
                        <version>4.0.23</version>
                    </dependency>
                    <dependency>
                        <groupId>org.yaml</groupId>
                        <artifactId>snakeyaml</artifactId>
                        <version>2.2</version>
                    </dependency>
                </dependencies>
                <executions>
                    <execution>
                        <id>load-db-config-from-yaml</id>
                        <phase>initialize</phase>
                        <goals>
                            <goal>execute</goal>
                        </goals>
                        <configuration>
                            <scripts>
                                <script><![CDATA[
  import org.yaml.snakeyaml.Yaml
  import java.nio.file.*

  def cfgPath = Paths.get(project.basedir.toString(), "plugins", "joupen", "config.yml")
  if (!Files.exists(cfgPath)) throw new RuntimeException("YAML config not found: " + cfgPath)

  def yaml = new Yaml()
  def map = yaml.load(Files.newInputStream(cfgPath)) ?: [:]
  def db  = (map["database"] instanceof Map) ? map["database"] : [:]

  // helper: eff = CLI (-Ddatabase.*) -> YAML -> defaults(from <properties>)
  def eff = [:]
  ["url","user","password","driver","schema"].each { k ->
    def cli   = project.properties.getProperty("database.${k}")              // из -D
    def yml   = (db[k] != null ? db[k].toString().trim() : null)            // из YAML
    def dflt  = project.properties.getProperty("database.${k}")             // дефолты уже объявлены в <properties>
    def val   = (cli && cli.trim()) ? cli.trim() : (yml && yml.trim() ? yml : dflt)
    if (val != null && val.toString().trim()) {
      project.properties.setProperty("database.${k}", val.toString().trim())
      eff[k] = val.toString().trim()
    }
  }

  println "[db-props] url="    + (eff.url    ?: "<unset>")
  println "[db-props] schema=" + (eff.schema ?: "<unset>")
]]></script>


                                <!-- 2) генерим jOOQ конфиг (без CDATA, с экранированием значений) -->
                                <script><![CDATA[
  import java.nio.file.*

  String xmlEscape(String s) {
    if (s == null) return ""
    s.replace("&","&amp;")
     .replace("<","&lt;")
     .replace(">","&gt;")
     .replace("\"","&quot;")
  }

  def outDir = Paths.get(project.build.directory)
  Files.createDirectories(outDir)
  def jooqCfg = outDir.resolve("jooq-config.xml")

  def url    = project.properties.getProperty("database.url") ?: ""
  def user   = project.properties.getProperty("database.user") ?: ""
  def pass   = project.properties.getProperty("database.password") ?: ""
  def driver = project.properties.getProperty("database.driver","org.mariadb.jdbc.Driver") ?: ""
  def schema = project.properties.getProperty("database.schema","Joupen") ?: ""

  def xml = """<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<configuration>
  <jdbc>
    <driver>${xmlEscape(driver)}</driver>
    <url>${xmlEscape(url)}</url>
    <user>${xmlEscape(user)}</user>
    <password>${xmlEscape(pass)}</password>
  </jdbc>
  <generator>
    <database>
      <name>org.jooq.meta.mariadb.MariaDBDatabase</name>
      <schemata>
        <schema>
          <inputSchema>${xmlEscape(schema)}</inputSchema>
          <outputSchemaToDefault>true</outputSchemaToDefault>
        </schema>
      </schemata>
      <includes>.*</includes>
      <forcedTypes>
        <forcedType>
          <priority>0</priority>
          <userType>java.lang.Boolean</userType>
          <binding>org.jooq.impl.BooleanToByteBinding</binding>
          <includeExpression>PAID</includeExpression>
          <includeTypes>TINYINT</includeTypes>
          <nullability>ALL</nullability>
          <objectType>ALL</objectType>
        </forcedType>
      </forcedTypes>
    </database>
    <target>
      <packageName>org.joupen.jooq.generated</packageName>
      <directory>${xmlEscape(project.build.directory)}/generated-sources/jooq</directory>
    </target>
    <generate>
      <javaTimeTypes>true</javaTimeTypes>
      <records>true</records>
      <pojos>true</pojos>
      <fluentSetters>true</fluentSetters>
      <defaultSchema>false</defaultSchema>
    </generate>
  </generator>
</configuration>
"""

  Files.writeString(jooqCfg, xml)
  project.properties.setProperty("jooq.config.file", jooqCfg.toString())
  println "[jooq-config] written: " + jooqCfg
]]></script>


                                <!-- 3) генерим liquibase.properties -->
                                <script><![CDATA[
                  import java.nio.file.*
                  def outDir = Paths.get(project.build.directory)
                  Files.createDirectories(outDir)
                  def lbProps = outDir.resolve("liquibase.properties")

                  def url    = project.properties.getProperty("database.url")
                  def user   = project.properties.getProperty("database.user")
                  def pass   = project.properties.getProperty("database.password")
                  def driver = project.properties.getProperty("database.driver","org.mariadb.jdbc.Driver")

                  def content = new StringBuilder()
                  content << "url=${url}\n"
                  content << "username=${user}\n"
                  content << "password=${pass}\n"
                  content << "driver=${driver}\n"
                  content << "changeLogFile=src/main/resources/db/changelog/db.changelog-master.yaml\n"
                  Files.writeString(lbProps, content.toString())
                  project.properties.setProperty("liquibase.properties.file", lbProps.toString())
                  println "[liquibase-properties] written: " + lbProps
                ]]></script>
                            </scripts>
                        </configuration>
                    </execution>
                </executions>
            </plugin>

            <!-- Компилятор -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.13.0</version>
                <configuration>
                    <source>${java.version}</source>
                    <target>${java.version}</target>
                    <annotationProcessorPaths>
                        <path>
                            <groupId>org.mapstruct</groupId>
                            <artifactId>mapstruct-processor</artifactId>
                            <version>${mapstruct.version}</version>
                        </path>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                            <version>1.18.34</version>
                        </path>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok-mapstruct-binding</artifactId>
                            <version>0.2.0</version>
                        </path>
                    </annotationProcessorPaths>
                </configuration>
            </plugin>

            <!-- Тесты -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
                <version>3.2.5</version>
                <configuration>
                    <includes>
                        <include>**/*Test.java</include>
                        <include>**/*Tests.java</include>
                        <include>**/*TestCase.java</include>
                    </includes>
                    <testFailureIgnore>false</testFailureIgnore>
                </configuration>
            </plugin>

            <!-- Shade -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-shade-plugin</artifactId>
                <version>3.5.0</version>
                <executions>
                    <execution>
                        <phase>package</phase>
                        <goals>
                            <goal>shade</goal>
                        </goals>
                        <configuration>
                            <createDependencyReducedPom>false</createDependencyReducedPom>
                            <filters>
                                <filter>
                                    <artifact>*:*</artifact>
                                    <includes>
                                        <include>**</include>
                                    </includes>
                                </filter>
                            </filters>
                            <transformers>
                                <transformer
                                        implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
                                    <manifestEntries>
                                        <Main-Class>org.joupen.JoupenPlugin</Main-Class>
                                    </manifestEntries>
                                </transformer>
                            </transformers>
                        </configuration>
                    </execution>
                </executions>
            </plugin>

            <!-- Ресурсы / копирование файлов -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-resources-plugin</artifactId>
                <version>3.3.1</version>
                <executions>
                    <execution>
                        <id>copy-changelog-files</id>
                        <phase>process-resources</phase>
                        <goals>
                            <goal>copy-resources</goal>
                        </goals>
                        <configuration>
                            <outputDirectory>${project.build.directory}/classes/db/changelog</outputDirectory>
                            <resources>
                                <resource>
                                    <directory>src/main/resources/db/changelog</directory>
                                    <includes>
                                        <include>**/*</include>
                                    </includes>
                                </resource>
                            </resources>
                        </configuration>
                    </execution>
                    <execution>
                        <id>copy-config-yml</id>
                        <phase>process-test-resources</phase>
                        <goals>
                            <goal>copy-resources</goal>
                        </goals>
                        <configuration>
                            <outputDirectory>${project.build.testOutputDirectory}/JoupenPlugin</outputDirectory>
                            <resources>
                                <resource>
                                    <directory>src/main/resources/JoupenPlugin</directory>
                                    <includes>
                                        <include>config.yml</include>
                                    </includes>
                                </resource>
                            </resources>
                        </configuration>
                    </execution>
                    <execution>
                        <id>copy-players-json</id>
                        <phase>process-resources</phase>
                        <goals>
                            <goal>copy-resources</goal>
                        </goals>
                        <configuration>
                            <outputDirectory>${project.build.directory}/classes/loginPluginRes</outputDirectory>
                            <resources>
                                <resource>
                                    <directory>src/main/resources</directory>
                                    <includes>
                                        <include>players.json</include>
                                    </includes>
                                    <filtering>true</filtering>
                                    <excludes>
                                        <exclude>docker-compose/**</exclude>
                                    </excludes>
                                </resource>
                            </resources>
                        </configuration>
                    </execution>
                </executions>
            </plugin>

            <!-- Liquibase: читаем propertyFile, чтобы не зависеть от ранней интерполяции -->
            <plugin>
                <groupId>org.liquibase</groupId>
                <artifactId>liquibase-maven-plugin</artifactId>
                <version>${liquibase.version}</version>
                <configuration>
                    <propertyFile>${liquibase.properties.file}</propertyFile>
                    <promptOnNonLocalDatabase>false</promptOnNonLocalDatabase>
                </configuration>
                <dependencies>
                    <dependency>
                        <groupId>org.mariadb.jdbc</groupId>
                        <artifactId>mariadb-java-client</artifactId>
                        <version>${mariadb.version}</version>
                    </dependency>
                </dependencies>
            </plugin>

            <!-- jOOQ codegen: читаем заранее сгенерированный конфиг -->
            <plugin>
                <groupId>org.jooq</groupId>
                <artifactId>jooq-codegen-maven</artifactId>
                <version>${jooq.version}</version>
                <executions>
                    <execution>
                        <id>generate-jooq-sources</id>
                        <phase>generate-sources</phase>
                        <goals>
                            <goal>generate</goal>
                        </goals>
                        <configuration>
                            <configurationFile>${jooq.config.file}</configurationFile>
                        </configuration>
                    </execution>
                </executions>
            </plugin>

            <!-- добавляем target/generated-sources/jooq -->
            <plugin>
                <groupId>org.codehaus.mojo</groupId>
                <artifactId>build-helper-maven-plugin</artifactId>
                <version>3.6.0</version>
                <executions>
                    <execution>
                        <phase>generate-sources</phase>
                        <goals>
                            <goal>add-source</goal>
                        </goals>
                        <configuration>
                            <sources>
                                <source>target/generated-sources/jooq</source>
                            </sources>
                        </configuration>
                    </execution>
                </executions>
            </plugin>

        </plugins>

        <resources>
            <resource>
                <directory>src/main/resources</directory>
                <filtering>true</filtering>
                <includes>
                    <include>**/*</include>
                </includes>
                <excludes>
                    <exclude>docker-compose/**</exclude>
                </excludes>
            </resource>
        </resources>
    </build>

    <profiles>
        <profile>
            <id>liquibase-update</id>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.liquibase</groupId>
                        <artifactId>liquibase-maven-plugin</artifactId>
                        <version>${liquibase.version}</version>
                        <executions>
                            <execution>
                                <phase>process-resources</phase>
                                <goals>
                                    <goal>update</goal>
                                </goals>
                            </execution>
                        </executions>
                        <configuration>
                            <propertyFile>${liquibase.properties.file}</propertyFile>
                            <promptOnNonLocalDatabase>false</promptOnNonLocalDatabase>
                        </configuration>
                        <dependencies>
                            <dependency>
                                <groupId>org.mariadb.jdbc</groupId>
                                <artifactId>mariadb-java-client</artifactId>
                                <version>${mariadb.version}</version>
                            </dependency>
                        </dependencies>
                    </plugin>
                </plugins>
            </build>
        </profile>
    </profiles>

    <repositories>
        <repository>
            <id>papermc-repo</id>
            <url>https://repo.papermc.io/repository/maven-public/</url>
        </repository>
        <repository>
            <id>sonatype</id>
            <url>https://oss.sonatype.org/content/groups/public/</url>
        </repository>
    </repositories>
</project>